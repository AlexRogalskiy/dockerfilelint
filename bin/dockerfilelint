#!/usr/bin/env node

var process = require('process');
var fs = require('fs');
var argv = require('yargs').argv;
var dockerfilelint = require('../lib/index');
var CliReporter = require('../lib/cli_reporter');
var chalk = require('chalk');

if (argv._.length === 0) {
  console.error('Usage: dockerfilelint <filename or dockerfile contents>');
  process.exit(1);
}

var fileContent;
try {
  var stats = fs.lstatSync(argv._[0]);
  if (stats.isFile()) {
    fileContent = fs.readFileSync(argv._[0], 'UTF-8');
  }
} catch (e) {
  if (e.code === 'ENOENT') {
    fileContent = argv._[0];
  }
}

if (!fileContent) {
  console.error(chalk.red('Invalid input'));
}

var result = dockerfilelint.run(fileContent);
var reporter = new CliReporter();
reporter.addFile(argv._[0], fileContent, result);
var report = reporter.buildReport();
console.log(report.toString());
process.exit(report.totalIssues);
